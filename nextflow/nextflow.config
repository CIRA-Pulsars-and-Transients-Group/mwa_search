#!/usr/bin/env nextflow

process {
    withLabel: 'gpu|cpu' {
        executor = 'slurm'
        cpus = 1
    }
}

// This should always be overwritten
params.obsid = "no_obsid"

hostname = "$HOSTNAME"

if ( hostname.startsWith("galaxy") ) {
    process {
        withLabel: 'gpu|cpu|cpu_backup' {
            cpus = 1
        }
        withLabel: gpu {
            queue = 'gpuq'
            executor = 'slurm'
        }
        withLabel: cpu {
            queue = 'workq'
            executor = 'slurm-magnus'
            clusterOptions = '--account=pawsey0348'
        }
        withLabel: cpu_backup {
            queue = 'workq'
            executor = 'slurm-magnus'
            clusterOptions = '--account=pawsey0348'
        }
        cache = 'lenient'
    }

    executor.queueSize = 90

    process.module = 'singularity/3.5.3'
    singularity {
        enabled = true
        //cacheDir = '/pawsey/mwa/singularity'
        runOptions = '--nv'
        envWhitelist = 'SINGULARITY_BINDPATH, SINGULARITYENV_LD_LIBRARY_PATH'
    }
    params.containerDir = '/pawsey/mwa/singularity'

    params.module_dir = '/group/mwa/software/modulefiles'
    params.presto_module_dir = '/group/mwa/software/modulefiles'
    params.presto_module = 'master'
    params.basedir = '/group/mwavcs/vcs'
    params.scratch_basedir = '/astro/mwavcs/vcs'
    params.search_dir = '/group/mwavcs/nswainston/pulsar_search'

    workDir = "/astro/mwavcs/${USER}/${params.obsid}_work"

    //Beamforming benchmarks
    params.bm_read  = 0.516
    params.bm_cal   = 0.298
    params.bm_beam  = 0.254
    params.bm_write = 0.032

    params.max_pointings = 20
}
if ( hostname.startsWith("garrawarla") ) {
    process {
        withLabel: 'gpu|cpu|cpu_backup' {
            cpus = 1
            executor = 'slurm'
        }
        withLabel: gpu {
            queue = 'gpuq'
            memory = "30 GB"
        }
        withLabel: cpu {
            queue = 'workq'
            memory = "3 GB"
            //clusterOptions = '--account=pawsey0348'
        }
        withLabel: cpu_backup {
            queue = 'workq'
            //clusterOptions = '--account=pawsey0348'
        }
        cache = 'lenient'
    }

    executor.$slurm.queueSize = 1000
    executor.dumpInterval = '1sec'
    executor.pollInterval = '1sec'
    executor.submitRateLimit = '100 sec'


    process.module = 'singularity/3.5.3'
    singularity {
        enabled = true
        //cacheDir = '/pawsey/mwa/singularity'
        runOptions = '--nv'
        envWhitelist = 'SINGULARITY_BINDPATH, SINGULARITYENV_LD_LIBRARY_PATH'
    }
    params.containerDir = '/pawsey/mwa/singularity'

    params.module_dir = '/group/mwa/software/modulefiles'
    params.presto_module_dir = '/group/mwa/software/modulefiles'
    params.presto_module = 'master'
    params.basedir = '/group/mwavcs/vcs'
    params.scratch_basedir = '/astro/mwavcs/vcs'
    params.search_dir = '/astro/mwavcs/pulsar_search'

    workDir = "/astro/mwavcs/${USER}/${params.obsid}_work"

    //Beamforming benchmarks
    params.bm_read  = 0.516
    params.bm_cal   = 0.298
    params.bm_beam  = 0.254
    params.bm_write = 0.032

    params.max_pointings = 20
}
else if ( hostname.startsWith("farnarkle") ) {
    process {
        withLabel: 'gpu|cpu|cpu_backup' {
            executor = 'slurm'
            cpus = 1
        }
        withLabel: gpu {
            queue = 'skylake-gpu'
            memory = "25 GB"
        }
        withLabel: cpu {
            queue = 'skylake'
            memory = "3 GB"
        }
        withLabel: cpu_backup {
            queue = 'sstar,gstar'
            memory = "3 GB"
        }
        cache = 'lenient'
    }

    executor.$slurm.queueSize = 1000
    executor.dumpInterval = '10sec'
    executor.pollInterval = '10sec'
    executor.submitRateLimit = '100 sec'

    process.module = 'singularity/latest'
    singularity {
        enabled = true
        //cacheDir = '/fred/oz125/container_images'
        autoMounts = true
        //runOptions = '-B /group -B /astro'
    }
    params.containerDir = '/fred/oz125/container_images'

    params.module_dir = '/fred/oz125/software/modulefiles'
    params.presto_module_dir = '/apps/users/pulsar/skylake/modulefiles'
    params.presto_module = 'd6265c2'
    params.basedir = '/fred/oz125/vcs'
    params.scratch_basedir = '/fred/oz125/vcs'
    params.search_dir = '/fred/oz125/nswainst/pulsar_search'

    workDir = "/fred/oz125/${USER}/${params.obsid}_work"

    //Beamforming benchmarks
    //params.bm_read  = 0.266 previous benchmark
    params.bm_read  = 0.366
    params.bm_cal   = 0.070
    params.bm_beam  = 0.120//0.039
    params.bm_write = 0.013

    params.max_pointings = 120
}
else if ( hostname.startsWith("x86") ) {
    process {
        withLabel: 'gpu|cpu|cpu_backup' {
            executor = 'slurm'
            cpus = 1
        }
        withLabel: gpu {
            queue = 'all-gpu'
            memory = "25 GB"
        }
        withLabel: cpu {
            queue = 'purley-cpu'
            memory = "10 GB"
        }
        withLabel: cpu_backup {
            queue = 'purley-cpu'
            memory = "10 GB"
        }
        cache = 'lenient'
    }

    executor.$slurm.queueSize = 1000
    executor.dumpInterval = '10sec'
    executor.pollInterval = '10sec'
    executor.submitRateLimit = '100 sec'

    singularity {
        enabled = true
        //cacheDir = '/o9000/MWA/Pulsar/vcs/singularity_images'
        //autoMounts = true
        runOptions = '-B /o9000 -B /home --nv'
    }
    params.containerDir = '/o9000/MWA/Pulsar/vcs/singularity_images'

    params.module_dir = '/home/nick/modules'
    params.presto_module_dir = '/home/app/modulefiles/'
    params.presto_module = 'cpu-master'
    params.basedir = '/o9000/MWA/Pulsar/vcs'
    params.scratch_basedir = '/o9000/MWA/Pulsar/vcs'
    params.search_dir = '/home/nick/pulsar_search'

    workDir = "/o9000/MWA/Pulsar/vcs/${params.obsid}_work"

    //Beamforming benchmarks
    //params.bm_read  = 0.266 previous benchmark
    params.bm_read  = 0.366*2
    params.bm_cal   = 0.070*2
    params.bm_beam  = 0.120*2
    params.bm_write = 0.013*2

    params.max_pointings = 120
}
